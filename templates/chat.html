{% extends "base.html" %}
{% block content %}
<h2>Global Room</h2>
<div id="messages" class="messages" style="border:1px solid #ccc; height:300px; overflow-y:auto; padding:5px;"></div>

<form id="message-form" class="chat-input">
  <input id="message-input" placeholder="Type a message..." autocomplete="off" required />
  <button type="submit">Send</button>
</form>

<!-- Socket.IO client served by Flask-SocketIO -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  const messages = document.getElementById("messages");
  const form = document.getElementById("message-form");
  const input = document.getElementById("message-input");

  const socket = io(); // connects to same-origin server

  function addMessage(html) {
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = html;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  // Listen for system messages
  socket.on("system", (data) => {
    addMessage(`<div class="sys" style="color:gray">${data.msg}</div>`);
  });

  // Listen for chat messages
  socket.on("receive_message", (data) => {
    const who = data.user === "{{ username }}" ? "me" : "them";
    addMessage(`<div class="${who}">
                  <b>${data.user}</b> <span class="ts">${data.ts}</span><br>
                  ${data.msg}
                </div>`);
  });

  // Send message to backend (FIXED: use 'SendMsg' to match server)
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const msg = input.value.trim();
    if (!msg) return;
    socket.emit("SendMsg", { msg });  // <-- FIXED here
    input.value = "";
    input.focus();
  });
</script>
{% endblock %}
